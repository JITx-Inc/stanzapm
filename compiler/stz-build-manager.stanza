defpackage stz/build-manager :
  import core
  import collections
  import stz/proj
  import stz/utils

public deftype BuildManager
public defmulti dependencies (b:BuildManager, packages:Tuple<Symbol>) -> ProjDependencies

public defn BuildManager (proj:ProjFile) :
  ;Build requirements and build table
  val req-table = to-hashtable(package,
    filter-by<RequiresStmt>(stmts(proj)))
  val build-table = to-hashtable(name,
    filter-by<BuildStmt>(stmts(proj)))
  ;Return build manager
  new BuildManager :
    defmethod dependencies (this, packages:Tuple<Symbol>) :
      defn field? (field:RequiresStmt -> Tuple<String>, p:Symbol) -> Tuple<String> :
        match(get?(req-table, p)) :
          (r:RequiresStmt) : field(r)
          (f:False) : []
      val ccfiles* = unique $ seq-cat(field?{ccfiles, _}, packages)
      val ccflags* = unique $ seq-cat(field?{ccflags, _}, packages)
      ProjDependencies(to-tuple(ccfiles*), to-tuple(ccflags*))

;============================================================
;===================== Result Structures ====================
;============================================================

public defstruct ProjDependencies :
  ccfiles: Tuple<String>
  ccflags: Tuple<String>